name: Build and Release

on:
  release:
    types: [created]

jobs:
  # Задача 1: Сборка macOS Intel (требует macOS-машины из-за Xcode)
  build_darwin_intel:
    name: Build macOS Intel (amd64)
    # ИЗМЕНЕНИЕ: Используем macOS-машину
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          
      - name: Setup fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest
        
      - name: Build and Package Darwin Intel
        # Компилируем напрямую, так как Xcode доступен
        run: |
          $HOME/go/bin/fyne-cross darwin \
            -arch amd64 \
            --icon cmd/icon.png \
            --app-id com.report.tracker \
            --name ReportTracker
          
      - name: Prepare Artifact Names
        run: |
          SOURCE_PATH="fyne-cross/bin/darwin-amd64/ReportTracker.app.tar.gz"
          ARTIFACT_NAME="ReportTracker_macOS_Intel.tar.gz"
          echo "SOURCE_PATH=${SOURCE_PATH}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
          
      - name: Copy Artifact to Root
        run: mv ${{ env.SOURCE_PATH }} ${{ env.ARTIFACT_NAME }}

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ARTIFACT_NAME }}


  # Задача 2: Сборка Windows и macOS M1 (может использовать Docker на Ubuntu)
  build_cross:
    name: Build Cross-Platform (${{ matrix.os }}/${{ matrix.arch }})
    runs-on: ubuntu-latest
    
    # ИЗМЕНЕНИЕ: Исключаем Intel, так как он собран выше.
    strategy:
      matrix:
        include:
          - os: windows
            arch: amd64
          - os: darwin # Только M1/ARM64
            arch: arm64 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Setup fyne-cross
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run Fyne-Cross Build
        # fyne-cross может собирать Windows и M1/ARM64 без Xcode
        run: |
          fyne-cross ${{ matrix.os }} \
            -arch ${{ matrix.arch }} \
            --icon cmd/icon.png \
            --app-id com.report.tracker \
            --name ReportTracker \
            --output ReportTracker

      - name: Prepare Artifact Names
        id: prepare_artifacts
        run: |
          OS_ARCH="${{ matrix.os }}-${{ matrix.arch }}"
          
          if [[ "${{ matrix.os }}" == "windows" ]]; then
              SOURCE_PATH="fyne-cross/bin/${OS_ARCH}/ReportTracker.exe"
              ARTIFACT_NAME="ReportTracker_Windows_x64.exe"
          elif [[ "${{ matrix.os }}" == "darwin" ]]; then
              SOURCE_PATH="fyne-cross/bin/${OS_ARCH}/ReportTracker.app.tar.gz"
              ARTIFACT_NAME="ReportTracker_macOS_M1.tar.gz"
          fi
          
          echo "SOURCE_PATH=${SOURCE_PATH}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
          
      - name: Copy Artifact to Root
        run: mv ${{ env.SOURCE_PATH }} ${{ env.ARTIFACT_NAME }}

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_NAME }}
