name: Build and Release

on:
  release:
    types: [created]

jobs:
  # Задача 1: Подготовка macOS SDK (выполняется 1 раз)
  prepare_darwin:
    name: Prepare Darwin SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup fyne-cross
        # Устанавливаем fyne-cross, который нужен для работы команды darwin-sdk-extract
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          
      - name: Extract Darwin SDK
        # Скачиваем и устанавливаем необходимый SDK Apple
        run: fyne-cross darwin-sdk-extract
        
      - name: Clean up
        # Удаляем временные файлы
        run: rm -f *.dmg

  # Задача 2: Главная сборка (зависит от подготовки SDK)
  build:
    name: Build for ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: [prepare_darwin] # Указываем, что сборка macOS зависит от успешной подготовки SDK
    
    strategy:
      matrix:
        include:
          - os: windows
            arch: amd64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Setup fyne-cross
        # Устанавливаем fyne-cross и добавляем его в PATH для этой задачи
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run Fyne-Cross Build
        # ФИНАЛЬНАЯ ИСПРАВЛЕННАЯ КОМАНДА:
        run: |
          fyne-cross ${{ matrix.os }} \
            -arch ${{ matrix.arch }} \
            --icon cmd/icon.png \ # Используем правильный путь к иконке
            --app-id com.report.tracker \
            --name ReportTracker \
            --output ReportTracker

      - name: Prepare Artifact Names
        id: prepare_artifacts
        run: |
          OS_ARCH="${{ matrix.os }}-${{ matrix.arch }}"
          
          if [[ "${{ matrix.os }}" == "windows" ]]; then
              SOURCE_PATH="fyne-cross/bin/${OS_ARCH}/ReportTracker.exe"
              ARTIFACT_NAME="ReportTracker_Windows_x64.exe"
          elif [[ "${{ matrix.os }}" == "darwin" ]]; then
              SOURCE_PATH="fyne-cross/bin/${OS_ARCH}/ReportTracker.app.tar.gz"
              
              if [[ "${{ matrix.arch }}" == "amd64" ]]; then
                  ARTIFACT_NAME="ReportTracker_macOS_Intel.tar.gz"
              else
                  ARTIFACT_NAME="ReportTracker_macOS_M1.tar.gz"
              fi
          fi
          
          echo "SOURCE_PATH=${SOURCE_PATH}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
          
      - name: Copy Artifact to Root
        run: mv ${{ env.SOURCE_PATH }} ${{ env.ARTIFACT_NAME }}

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_NAME }}
